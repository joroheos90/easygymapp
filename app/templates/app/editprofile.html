{% extends "app/base.html" %} {% load customfilters %} {% block title %}
{{is_edit|yesno:"Editar Miembro,Nuevo Miembro" }}{% endblock %} 
{% block headerTitle %}Perfil{% endblock %} {% block headerButtons %}
<a
    href="{% if request.is_member %}{% url 'app.profile' %}{% else %}{% url 'app.users' %}{% endif %}"
    class="cursor-pointer text-lg font-normal text-blue-500"
    >Cancelar</a
>
<button form="user-form" class="cursor-pointer text-lg font-bold text-blue-500">
    Guardar
</button>
{% endblock %} {% block content %}
<form
    id="user-form"
    method="post"
    class="flex flex-col gap-6 px-4 py-4 pb-6 font-roboto"
>
    {% csrf_token %}

    <div
        class="h-[140px] mx-auto min-h-[140px] bg-blue-400 text-[70px] font-bold flex items-center justify-center w-[140px] min-w-[140px] rounded-full"
    >
        {{full_name|initials}}
    </div>

    <div class="flex flex-col gap-4">
        <div class="flex flex-col rounded-[8px] bg-white px-4">
            <input
                type="text"
                name="first_name"
                value="{{ first_name }}"
                class="w-full border-b border-gray-300 px-1 py-3 text-base font-normal capitalize ring-0 focus:ring-0 focus:outline-none"
                placeholder="Nombre"
                autocomplete="off"
            />
            <input
                type="text"
                name="last_name"
                value="{{ last_name }}"
                class="w-full px-1 py-3 text-base font-normal capitalize ring-0 focus:ring-0 focus:outline-none"
                placeholder="Apellidos"
                autocomplete="off"
            />
            <div class="relative">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="absolute top-3 left-1 size-5"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 8.25v-1.5m0 1.5c-1.355 0-2.697.056-4.024.166C6.845 8.51 6 9.473 6 10.608v2.513m6-4.871c1.355 0 2.697.056 4.024.166C17.155 8.51 18 9.473 18 10.608v2.513M15 8.25v-1.5m-6 1.5v-1.5m12 9.75-1.5.75a3.354 3.354 0 0 1-3 0 3.354 3.354 0 0 0-3 0 3.354 3.354 0 0 1-3 0 3.354 3.354 0 0 0-3 0 3.354 3.354 0 0 1-3 0L3 16.5m15-3.379a48.474 48.474 0 0 0-6-.371c-2.032 0-4.034.126-6 .371m12 0c.39.049.777.102 1.163.16 1.07.16 1.837 1.094 1.837 2.175v5.169c0 .621-.504 1.125-1.125 1.125H4.125A1.125 1.125 0 0 1 3 20.625v-5.17c0-1.08.768-2.014 1.837-2.174A47.78 47.78 0 0 1 6 13.12M12.265 3.11a.375.375 0 1 1-.53 0L12 2.845l.265.265Zm-3 0a.375.375 0 1 1-.53 0L9 2.845l.265.265Zm6 0a.375.375 0 1 1-.53 0L15 2.845l.265.265Z"
                    />
                </svg>

                <input
                    type="date"
                    name="birth_date"
                    value="{{ birth_date }}"
                    style="
                        padding-left: 28px;
                        padding-top: 12px;
                        padding-bottom: 12px;
                        height: 48px;
                        min-height: 48px;
                        line-height: 24px;
                    "
                    class="w-full pl-7 py-3 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
                    placeholder="Fecha de nacimiento"
                />
            </div>
        </div>

        <div class="flex flex-col rounded-[8px] bg-white px-4">
            <input
                type="text"
                name="phone"
                value="{{ phone }}"
                class="w-full appearance-none border-b border-gray-300 px-1 py-3 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
                placeholder="Teléfono"
                autocomplete="tel"
            />
            <div class="relative">
                <span class="absolute top-4 text-xs">Ingreso</span>

                <input
                    type="date"
                    name="join_date"
                    value="{{join_date}}"
                    style="
                        padding-left: 44px;
                        padding-top: 12px;
                        padding-bottom: 12px;
                        height: 48px;
                        min-height: 48px;
                        line-height: 24px;
                    "
                    {% if is_member %}disabled{% endif %}
                    class="w-full py-3 disabled:bg-gray-200 disabled:text-gray-400 pl-11 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
                />
            </div>
        </div>

        <div class="flex flex-col rounded-[8px] bg-white px-4">
            <input
                type="number"
                step="1"
                min="0"
                name="height_cm"
                value="{{ height_cm }}"
                class="w-full appearance-none border-b border-gray-300 px-1 py-3 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
                placeholder="Estatura en centímetros (opcional)"
            />
        </div>
    </div>
</form>

{% if is_edit and is_admin %}
<form
    method="post"
    class="flex flex-col items-center rounded-[8px] bg-white mx-4 px-4 py-2 my-4"
    onsubmit="return confirm('¿Seguro que quieres borrar este miembro? Esta acción no se puede deshacer.');"
>
    {% csrf_token %}
    <input type="hidden" name="action" value="delete" />
    <button
        type="submit"
        class="cursor-pointer font-normal text-red-500 text-left"
    >
        Borrar Miembro
    </button>
</form>
{% endif %}

{% if is_edit and is_member %}
<div method="post" class="flex flex-col mb-6 items-center rounded-[8px] bg-white mx-4 px-4 py-2 my-4">
    <a href="{% url 'app.password_change' %}" class="cursor-pointer font-normal text-blue-500 text-left">
        Cambiar mi contraseña
    </a>
</div>
{% endif %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
      // Toma el input por name (funciona sin id). Cambia a '#phone' si le pones id.
      const el = document.querySelector('input[name="phone"]');
      if (!el) return;
    
      const onlyDigits = (s) => (s || "").replace(/\D+/g, "");
      const formatCR = (s) => {
        const raw = onlyDigits(s).slice(0, 8);     // máx 8 dígitos
        if (!raw) return "";
        if (raw.length <= 4) return raw;           // "1234"
        return raw.slice(0, 4) + "-" + raw.slice(4); // "1234-5678"
      };
    
      function setFieldError(msg) {
        let hint = el.nextElementSibling;
        if (!hint || !hint.classList.contains("field-hint")) {
          hint = document.createElement("div");
          hint.className = "field-hint text-xs mt-1";
          el.insertAdjacentElement("afterend", hint);
        }
        hint.textContent = msg || "";
        hint.style.color = msg ? "#dc2626" : ""; // rojo si hay error
      }
    
      // Formateo al cargar
      el.value = formatCR(el.value);
    
      // Mientras escriben/pegan
      el.addEventListener("input", function () {
        const before = el.value;
        const formatted = formatCR(before);
        if (before !== formatted) {
          el.value = formatted;
          // Cursor al final (simple y robusto en móvil)
          el.setSelectionRange(el.value.length, el.value.length);
        }
        // Feedback suave
        const len = onlyDigits(el.value).length;
        if (len > 0 && len !== 8) setFieldError("El teléfono debe tener 8 dígitos.");
        else setFieldError("");
      });
    
      // Al salir del campo
      el.addEventListener("blur", function () {
        el.value = formatCR(el.value);
        const len = onlyDigits(el.value).length;
        if (len !== 8) setFieldError("El teléfono debe tener 8 dígitos.");
      });
    
      // Enviar sin guion
      const form = el.closest("form");
      if (form) {
        form.addEventListener("submit", function (e) {
          const raw = onlyDigits(el.value);
          if (raw.length !== 8) {
            e.preventDefault();
            setFieldError("El teléfono debe tener 8 dígitos.");
            el.focus();
            return;
          }
          el.value = raw; // "12345678" para el servidor
        });
      }
    });
    </script>
    
{% endblock %}

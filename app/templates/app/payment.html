{% extends "app/base.html" %} {% load customfilters %} {% block title %}
{{is_edit|yesno:"Editar Pago,Nuevo Pago" }}{% endblock %} 
{% block headerTitle %}Pago{% endblock %} {% block headerButtons %}
<a
    href="{% if request.is_member %}{% url 'app.profile' %}{% elif payment_id %}{% url 'app.payments' %}{% else %}{% url 'app.admin' %}{% endif %}"
    class="cursor-pointer text-lg font-normal text-blue-500"
    >Cancelar</a
>
<button form="pago-form" class="cursor-pointer text-lg font-bold text-blue-500">
    Guardar
</button>
{% endblock %} {% block content %}
<form
    id="pago-form"
    method="post"
    class="flex flex-col gap-6 px-4 py-6 pb-6 font-roboto"
>
    {% if error %}
        <div
            class="fixed right-2 bottom-0 left-2 rounded-t-[12px] bg-red-600 p-4 text-center text-base font-bold text-white"
        >
            {{error}}
        </div>
    {% endif %}
    {% csrf_token %}

    {% if is_edit %}
    <input type="hidden" name="pagoid" value="{{ pagoid }}" />
    {% endif %}

    <div class="flex flex-col gap-4">
        <div class="flex flex-col rounded-[8px] bg-white px-4">
            <select
                name="user"
                style="
                        padding-top: 12px;
                        padding-bottom: 12px;
                        height: 48px;
                        min-height: 48px;
                        line-height: 24px;
                    "
                class="w-full capitalize py-3 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
            >
                <option value="">Miembro</option>
                {% for u in users %}
                    <option class="capitalize" value="{{ u.id }}" {% if initial.user_id == u.id %}selected{% endif %}>{{ u.full_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex flex-col rounded-[8px] bg-white px-4">
            <div class="flex items-center gap-2 border-b border-gray-400">
                <span class="pt-3 pb-3 text-base">$</span>
                <input
                    type="text"
                    name="amount"
                    id="amount"
                    inputmode="numeric"
                    value="{{initial.amount}}"
                    autocomplete="off"
                    class="w-full px-1 py-3 text-right text-base font-normal tracking-widest ring-0 focus:ring-0 focus:outline-none"
                    placeholder="Monto"
                />
            </div>
            <select
                name="method"
                style="
                        padding-top: 12px;
                        padding-bottom: 12px;
                        height: 48px;
                        min-height: 48px;
                        line-height: 24px;
                    "
                class="w-full py-3 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
            >
                <option value="">Metodo de pago</option>
                {% for val,label in methods %}
                    <option value="{{ val }}" {% if initial.method == val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex flex-col rounded-[8px] bg-white px-4">
            <div class="relative border-b border-gray-400">
                <span class="absolute top-4 text-xs">Pagado</span>

                <input
                    type="date"
                    name="paid_at"
                    style="
                        padding-left: 44px;
                        padding-top: 12px;
                        padding-bottom: 12px;
                        height: 48px;
                        min-height: 48px;
                        line-height: 24px;
                    "
                    value="{{ initial.paid_at }}"
                    class="w-full py-3 pl-11 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
                />
            </div>
            <select
                name="period"
                style="
                        padding-top: 12px;
                        padding-bottom: 12px;
                        height: 48px;
                        min-height: 48px;
                        line-height: 24px;
                    "
                class="w-full py-3 text-base font-normal ring-0 focus:ring-0 focus:outline-none"
            >
                <option value="">Periodo</option>
                {% for val,label in periods %}
                    <option value="{{ val }}" {% if initial.period == val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex flex-col rounded-[8px] bg-white px-4">
            <textarea
                rows="5"
                type="text"
                name="notes"
                class="w-full appearance-none px-1 py-3 text-sm font-normal capitalize ring-0 focus:ring-0 focus:outline-none"
                placeholder="Notas (no obligatorio)"
            ></textarea>
        </div>
    </div>
</form>

{% if is_edit and is_admin %}
<form
    method="post"
    class="flex flex-col items-center rounded-[8px] bg-white mx-4 px-4 py-2 my-4"
    onsubmit="return confirm('¿Seguro que quieres borrar este pago? Esta acción no se puede deshacer.');"
>
    {% csrf_token %}
    <input type="hidden" name="action" value="delete" />
    <button
        type="submit"
        class="cursor-pointer font-normal text-red-500 text-left"
    >
        Borrar Pago
    </button>
</form>
{% endif %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
      const el = document.getElementById("amount");
      if (!el) return;
    
      const onlyDigits = (s) => (s || "").replace(/[^\d]/g, "");
      const formatThousands = (s) => {
        const raw = onlyDigits(s);
        if (!raw) return "";
        return raw.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      };
    
      // ---- FORMATEO AL CARGAR ----
      el.value = formatThousands(el.value);
    
      // ---- mientras escriben/pegan ----
      el.addEventListener("input", function () {
        const start = el.selectionStart;
        const before = el.value;
        const formatted = formatThousands(before);
        if (before !== formatted) {
          el.value = formatted;
          // coloca el cursor al final (simple y robusto para móvil)
          el.setSelectionRange(el.value.length, el.value.length);
        }
      });
    
      // ---- al salir del campo ----
      el.addEventListener("blur", function () {
        el.value = formatThousands(el.value);
      });
    
      // ---- al enviar, quitar puntos ----
      const form = el.closest("form");
      if (form) {
        form.addEventListener("submit", function () {
          el.value = onlyDigits(el.value); // "12.345" -> "12345"
        });
      }
    });
    </script>
    
{% endblock %}

{% extends "app/base.html" %}
{% load customfilters %}

{% block title %}Medición{% endblock %}
{% block headerTitle %}Medición{% endblock %}

{% block headerButtons %}
<a
    href="{% url 'app.user_measurements' %}?userid={{ user.id }}"
    class="cursor-pointer text-lg font-normal"
>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
         stroke-width="1.5" stroke="currentColor" class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M15.75 19.5 8.25 12l7.5-7.5"/>
    </svg>
</a>
{% if request.is_admin %}
<button form="measurement-form" class="text-blue-500 font-bold">Guardar</button>
{% endif %}
{% endblock %}

{% block content %}
<form
    id="measurement-form"
    method="post"
    class="flex flex-col gap-6 px-4 py-6 font-roboto min-h-screen"
>
    {% csrf_token %}

    {% if is_edit and request.is_admin %}
        <input type="hidden" name="recordid" value="{{ record.id }}">
    {% endif %}
    <input type="hidden" name="userid" value="{{ user_id }}">

    {% if error %}
    <div class="fixed right-2 bottom-0 left-2 rounded-t-[12px] bg-red-600 p-4
                text-center text-base font-bold text-white">
        {{ error }}
    </div>
    {% endif %}

    <div class="rounded-[8px] bg-white px-4">
        <input
            type="date"
            name="record_date"
            {% if not request.is_admin %}disabled{% endif %}
            value="{{ record.record_date|date:'Y-m-d' }}"
            class="w-full py-3 text-base ring-0 focus:ring-0 focus:outline-none"
        />
    </div>

    <div class="rounded-[24px] bg-white p-4 flex flex-col gap-4">
        <h3 class="text-sm font-bold text-gray-500 uppercase">
            Mediciones principales
        </h3>
        {% for d in primary_definitions %}
        <div class="flex justify-between border-b border-gray-300">
            <span class="text-sm font-bold uppercase text-gray-600">
                {{ d.name }}{% if d.is_required %}*{% endif %}
            </span>
            <div class="flex items-center gap-2">
                <input
                    type="text"
                    name="def_{{ d.id }}"
                    value="{{ initial|get_item:d.name }}"
                    {% if not request.is_admin %}disabled{% endif %}
                    data-unit-type="{{ d.unit_type }}"
                    inputmode="{% if d.unit_type != 'text' %}decimal{% endif %}"
                    class="measurement-input w-24 text-right text-base ring-0 focus:ring-0 focus:outline-none"
                />
                <span class="text-xs text-gray-500">{{ d.unit_type }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="rounded-[24px] bg-white p-4 flex flex-col gap-4">
        <h3 class="text-sm font-bold text-gray-500 uppercase">
            Otras mediciones
        </h3>
        {% for d in secondary_definitions %}
        <div class="flex justify-between border-b border-gray-200">
            <span class="text-sm capitalize text-gray-600">{{ d.name }}</span>
            <div class="flex items-center gap-2">
                <input
                    type="text"
                    name="def_{{ d.id }}"
                    value="{{ initial|get_item:d.name }}"
                    {% if not request.is_admin %}disabled{% endif %}
                    data-unit-type="{{ d.unit_type }}"
                    inputmode="{% if d.unit_type != 'text' %}decimal{% endif %}"
                    class="measurement-input w-24 text-right text-base ring-0 focus:ring-0 focus:outline-none"
                />
                <span class="text-xs text-gray-500">{{ d.unit_type }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if is_edit and request.is_admin %}
    <div class="rounded-[12px] bg-white px-4 py-3 text-center">
        <button
            type="submit"
            name="action"
            value="delete"
            class="text-red-500"
            onclick="return confirm('¿Borrar medición?')"
        >
            Borrar medición
        </button>
    </div>
    {% endif %}
</form>
{% if request.is_admin %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
    
        const inputs = document.querySelectorAll(".measurement-input");
    
        const onlyNumbers = (v) => v.replace(/[^\d.]/g, "");
        const onlyIntegers = (v) => v.replace(/[^\d]/g, "");
    
        inputs.forEach(input => {
            const type = input.dataset.unitType;
    
            if (type === "text") return;
    
            input.addEventListener("input", () => {
                let v = input.value;
    
                switch (type) {
    
                    case "kg":
                        // decimal, máx 2 decimales
                        v = onlyNumbers(v);
                        if (v.includes(".")) {
                            const [a, b] = v.split(".");
                            v = a + "." + b.slice(0, 2);
                        }
                        break;
    
                    case "cm":
                        // entero positivo
                        v = onlyIntegers(v);
                        break;
    
                    case "%":
                        // decimal 0–100
                        v = onlyNumbers(v);
                        if (v.includes(".")) {
                            const [a, b] = v.split(".");
                            v = a + "." + b.slice(0, 1);
                        }
                        const n = parseFloat(v);
                        if (!isNaN(n)) {
                            if (n > 100) v = "100";
                            if (n < 0) v = "0";
                        }
                        break;
    
                    case "#":
                        // decimal libre
                        v = onlyNumbers(v);
                        break;
                }
    
                input.value = v;
            });
        });
    
        // Limpieza final antes de enviar (evita "12.")
        const form = document.getElementById("measurement-form");
        form.addEventListener("submit", () => {
            inputs.forEach(input => {
                if (input.value.endsWith(".")) {
                    input.value = input.value.slice(0, -1);
                }
            });
        });
    });
    </script>
{% endif %}
{% endblock %}
